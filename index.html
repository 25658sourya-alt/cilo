<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cilo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=Kalam:wght@300;400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    /* â”€â”€ tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --egg-white: #FFF3BD;
      --cream:     #FFFDD1;
      --lav:       #C4ACE3;
      --kawaii:    #A287D0;
      --arianna:   #7851A7;
      --ink:       #2a1d45;
      --ink-mid:   #5c4580;
      --ink-soft:  #8e78b0;
      --surface:   #fffef8;
      --radius:    14px;
    }

    /* â”€â”€ reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* â”€â”€ base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html, body {
      height: 100%;
      font-family: 'Kalam', cursive;
      background: var(--cream);
      color: var(--ink);
      overflow: hidden;
    }

    /* subtle dot-grid â€” notebook paper feel */
    body {
      background-image: radial-gradient(var(--lav) 1px, transparent 1px);
      background-size: 26px 26px;
      background-color: var(--cream);
    }

    /* â”€â”€ layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      height: 100vh;
    }

    /* â”€â”€ sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      background: var(--egg-white);
      border-right: 2px dashed var(--lav);
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
      overflow: hidden;
    }

    .logo {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding-bottom: 16px;
      border-bottom: 1.5px dashed var(--lav);
    }

    .logo-name {
      font-family: 'Caveat', cursive;
      font-size: 42px;
      font-weight: 700;
      color: var(--arianna);
      line-height: 1;
      display: inline-block;
      transform: rotate(-1.5deg); /* the one deliberate imperfection */
    }

    .logo-tagline {
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 300;
      padding-left: 2px;
    }

    .new-chat-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 14px;
      background: var(--kawaii);
      color: #fff;
      border: 2px solid var(--arianna);
      border-radius: var(--radius);
      font-family: 'Kalam', cursive;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s, transform 0.15s;
      width: 100%;
    }

    .new-chat-btn:hover {
      background: var(--arianna);
      transform: translateY(-1px);
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      overflow-y: auto;
    }

    .nav::-webkit-scrollbar { width: 3px; }
    .nav::-webkit-scrollbar-thumb { background: var(--lav); border-radius: 4px; }

    .nav-label {
      font-size: 11px;
      font-weight: 300;
      color: var(--ink-soft);
      text-transform: lowercase;
      letter-spacing: 0.8px;
      padding: 10px 4px 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1.5px solid transparent;
      font-family: 'Kalam', cursive;
      font-size: 14px;
      color: var(--ink-mid);
      cursor: pointer;
      transition: background 0.12s, border-color 0.12s, color 0.12s;
      user-select: none;
    }

    .nav-item:hover {
      background: var(--lav);
      color: var(--ink);
    }

    .nav-item.active {
      background: var(--lav);
      border-color: var(--kawaii);
      color: var(--arianna);
      font-weight: 700;
    }

    .sidebar-foot {
      font-size: 11px;
      color: var(--lav);
      text-align: center;
      padding-top: 8px;
      border-top: 1.5px dashed var(--lav);
      font-weight: 300;
    }

    /* â”€â”€ main panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 28px;
      border-bottom: 1.5px dashed var(--lav);
      background: var(--cream);
      flex-shrink: 0;
    }

    .topbar-title {
      font-family: 'Caveat', cursive;
      font-size: 18px;
      color: var(--ink-soft);
    }

    .discipline-pill {
      font-size: 13px;
      padding: 4px 14px;
      background: var(--egg-white);
      border: 1.5px solid var(--lav);
      border-radius: 100px;
      color: var(--arianna);
    }

    /* â”€â”€ message feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .feed {
      flex: 1;
      overflow-y: auto;
      padding: 28px 0;
      scroll-behavior: smooth;
    }

    .feed::-webkit-scrollbar { width: 5px; }
    .feed::-webkit-scrollbar-thumb { background: var(--lav); border-radius: 4px; }

    /* â”€â”€ welcome screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .welcome {
      max-width: 580px;
      margin: 24px auto 0;
      padding: 0 28px;
      animation: rise 0.45s cubic-bezier(0.22, 1, 0.36, 1) both;
    }

    .welcome-badge {
      display: inline-block;
      font-family: 'Caveat', cursive;
      font-size: 13px;
      background: var(--kawaii);
      color: #fff;
      padding: 3px 12px;
      border-radius: 100px;
      margin-bottom: 14px;
      transform: rotate(-1deg);
    }

    .welcome-heading {
      font-family: 'Caveat', cursive;
      font-size: 46px;
      font-weight: 700;
      line-height: 1.1;
      color: var(--arianna);
      margin-bottom: 4px;
    }

    .squiggle {
      display: block;
      margin: 0 0 16px 2px;
    }

    .welcome-desc {
      font-size: 15px;
      font-weight: 300;
      line-height: 1.7;
      color: var(--ink-mid);
      background: var(--egg-white);
      border: 1.5px dashed var(--lav);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 24px;
    }

    .starter-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .starter-card {
      padding: 12px 14px;
      background: var(--egg-white);
      border: 1.5px solid var(--lav);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13.5px;
      line-height: 1.5;
      color: var(--ink);
      transition: border-color 0.15s, transform 0.15s, box-shadow 0.15s;
    }

    /* each card slightly tilted for handmade feel */
    .starter-card:nth-child(odd)  { transform: rotate(-0.6deg); }
    .starter-card:nth-child(even) { transform: rotate(0.5deg); }

    .starter-card:hover {
      border-color: var(--kawaii);
      transform: rotate(0deg) translateY(-2px);
      box-shadow: 0 4px 14px rgba(162, 135, 208, 0.25);
    }

    .starter-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      color: var(--kawaii);
      text-transform: lowercase;
      letter-spacing: 0.8px;
      margin-bottom: 5px;
    }

    /* â”€â”€ message rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .message {
      max-width: 680px;
      margin: 0 auto 22px;
      padding: 0 28px;
      animation: rise 0.3s cubic-bezier(0.22, 1, 0.36, 1) both;
    }

    .message-row {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 2px solid;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .avatar--user { background: var(--egg-white); border-color: var(--kawaii); }
    .avatar--cilo { background: var(--lav);       border-color: var(--arianna); }

    .message-body { flex: 1; min-width: 0; }

    .message-sender {
      font-size: 11px;
      font-weight: 600;
      color: var(--ink-soft);
      letter-spacing: 0.8px;
      text-transform: lowercase;
      margin-bottom: 5px;
    }

    .bubble {
      display: inline-block;
      max-width: 100%;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 16px;
      line-height: 1.75;
    }

    .bubble--user {
      background: var(--kawaii);
      color: #fff;
      border: 1.5px solid var(--arianna);
      font-style: italic;
    }

    .bubble--cilo {
      background: var(--surface);
      color: var(--ink);
      border: 1.5px solid var(--lav);
      width: 100%;
    }

    .bubble--cilo p            { margin-bottom: 10px; }
    .bubble--cilo p:last-child { margin-bottom: 0; }
    .bubble--cilo strong       { color: var(--arianna); }
    .bubble--cilo em           { color: var(--kawaii); font-style: italic; }
    .bubble--cilo blockquote {
      border-left: 3px solid var(--kawaii);
      padding-left: 12px;
      margin: 8px 0;
      color: var(--ink-mid);
      font-style: italic;
    }

    /* â”€â”€ typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .typing-dots {
      display: flex;
      gap: 5px;
      padding: 4px 2px;
      align-items: center;
    }

    .typing-dots span {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--kawaii);
      animation: bounce 1.1s ease-in-out infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.16s; background: var(--arianna); }
    .typing-dots span:nth-child(3) { animation-delay: 0.32s; background: var(--lav); }

    /* â”€â”€ composer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .composer {
      flex-shrink: 0;
      padding: 14px 28px 20px;
      background: var(--egg-white);
      border-top: 1.5px dashed var(--lav);
    }

    .composer-inner {
      max-width: 680px;
      margin: 0 auto;
      position: relative;
    }

    .composer-textarea {
      width: 100%;
      background: var(--cream);
      border: 1.5px solid var(--lav);
      border-radius: var(--radius);
      padding: 13px 56px 13px 18px;
      font-family: 'Kalam', cursive;
      font-size: 16px;
      color: var(--ink);
      resize: none;
      min-height: 52px;
      max-height: 160px;
      line-height: 1.55;
      outline: none;
      transition: border-color 0.18s, box-shadow 0.18s;
    }

    .composer-textarea::placeholder { color: var(--lav); font-style: italic; }

    .composer-textarea:focus {
      border-color: var(--kawaii);
      box-shadow: 0 0 0 3px rgba(162, 135, 208, 0.18);
    }

    .send-btn {
      position: absolute;
      right: 10px;
      bottom: 10px;
      width: 36px;
      height: 36px;
      background: var(--arianna);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      transition: background 0.15s, transform 0.15s;
    }

    .send-btn:hover    { background: var(--kawaii); transform: scale(1.08); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .send-btn svg { width: 16px; height: 16px; }

    .composer-hint {
      max-width: 680px;
      margin: 7px auto 0;
      font-size: 11px;
      font-weight: 300;
      color: var(--ink-soft);
      text-align: center;
    }

    /* â”€â”€ animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes rise {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.75); opacity: 0.5; }
      40%           { transform: scale(1);    opacity: 1; }
    }

    /* â”€â”€ responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      .layout            { grid-template-columns: 1fr; }
      .sidebar           { display: none; }
      .starter-grid      { grid-template-columns: 1fr; }
      .welcome-heading   { font-size: 34px; }
    }
  </style>
</head>
<body>

<div class="layout">

  <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="sidebar">

    <div class="logo">
      <span class="logo-name">cilo</span>
      <span class="logo-tagline">âœ¦ humanities ai companion</span>
    </div>

    <button class="new-chat-btn" onclick="App.reset()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
        <line x1="12" y1="5" x2="12" y2="19"/>
        <line x1="5"  y1="12" x2="19" y2="12"/>
      </svg>
      new inquiry
    </button>

    <nav class="nav" aria-label="Disciplines">
      <span class="nav-label">fields of study</span>
      <div class="nav-item active" data-disc="philosophy"       onclick="App.setDiscipline(this)"><span>ğŸª·</span> philosophy</div>
      <div class="nav-item"        data-disc="history"          onclick="App.setDiscipline(this)"><span>ğŸ“œ</span> history</div>
      <div class="nav-item"        data-disc="literature"       onclick="App.setDiscipline(this)"><span>ğŸ“–</span> literature</div>
      <div class="nav-item"        data-disc="art history"      onclick="App.setDiscipline(this)"><span>ğŸ¨</span> art history</div>
      <div class="nav-item"        data-disc="linguistics"      onclick="App.setDiscipline(this)"><span>ğŸ—£</span> linguistics</div>
      <div class="nav-item"        data-disc="religious studies" onclick="App.setDiscipline(this)"><span>ğŸ•Š</span> religious studies</div>
      <div class="nav-item"        data-disc="classical studies" onclick="App.setDiscipline(this)"><span>ğŸº</span> classical studies</div>
      <div class="nav-item"        data-disc="ethics"           onclick="App.setDiscipline(this)"><span>ğŸŒ¿</span> ethics</div>
      <div class="nav-item"        data-disc="cultural studies" onclick="App.setDiscipline(this)"><span>ğŸŒ</span> cultural studies</div>
      <div class="nav-item"        data-disc="political theory" onclick="App.setDiscipline(this)"><span>ğŸŒ±</span> political theory</div>
    </nav>

    <p class="sidebar-foot">made with care, for curious minds ğŸ’œ</p>
  </aside>

  <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="main">

    <header class="topbar">
      <span class="topbar-title">a space to think out loud</span>
      <span class="discipline-pill" id="discipline-pill">ğŸª· philosophy</span>
    </header>

    <div class="feed" id="feed">

      <div class="welcome" id="welcome">
        <span class="welcome-badge">new here? start below â†“</span>

        <h1 class="welcome-heading">ask cilo anything<br/>about being human.</h1>

        <svg class="squiggle" width="210" height="14" viewBox="0 0 210 14"
             fill="none" aria-hidden="true">
          <path d="M2 9 Q30 3 60 10 Q90 17 120 7 Q150 -1 180 9 Q195 14 208 8"
                stroke="#C4ACE3" stroke-width="2.5" stroke-linecap="round"/>
        </svg>

        <p class="welcome-desc">
          philosophy Â· history Â· literature Â· art Â· language Â· religion â€”
          explored with real depth, warmth, and multiple perspectives. no bullet points here.
        </p>

        <div class="starter-grid">
          <div class="starter-card" onclick="App.useStarter(this)">
            <span class="starter-label">âœ¦ philosophy</span>
            What's the difference between Kant's categorical imperative and Mill's utilitarianism?
          </div>
          <div class="starter-card" onclick="App.useStarter(this)">
            <span class="starter-label">âœ¦ literature</span>
            Explain the unreliable narrator in Dostoevsky's Notes from Underground.
          </div>
          <div class="starter-card" onclick="App.useStarter(this)">
            <span class="starter-label">âœ¦ history</span>
            What were the intellectual roots of the French Revolution?
          </div>
          <div class="starter-card" onclick="App.useStarter(this)">
            <span class="starter-label">âœ¦ art history</span>
            How did Renaissance perspective change Western art?
          </div>
          <div class="starter-card" onclick="App.useStarter(this)">
            <span class="starter-label">âœ¦ linguistics</span>
            What is Saussure's distinction between langue and parole?
          </div>
          <div class="starter-card" onclick="App.useStarter(this)">
            <span class="starter-label">âœ¦ ethics</span>
            Is moral relativism self-defeating? Argue both sides.
          </div>
        </div>
      </div>

    </div><!-- /feed -->

    <footer class="composer">
      <div class="composer-inner">
        <textarea
          class="composer-textarea"
          id="composer-input"
          rows="1"
          placeholder="write your question hereâ€¦ (shift+enter for new line)"
          aria-label="Message input"
        ></textarea>
        <button class="send-btn" id="send-btn" aria-label="Send">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
      <p class="composer-hint">
        cilo thinks carefully Â· references real thinkers Â· explores many angles âœ¦
      </p>
    </footer>

  </main>
</div>

<script>
  /* â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const DISCIPLINE_ICONS = {
    'philosophy':       'ğŸª·',
    'history':          'ğŸ“œ',
    'literature':       'ğŸ“–',
    'art history':      'ğŸ¨',
    'linguistics':      'ğŸ—£',
    'religious studies':'ğŸ•Š',
    'classical studies':'ğŸº',
    'ethics':           'ğŸŒ¿',
    'cultural studies': 'ğŸŒ',
    'political theory': 'ğŸŒ±',
  };

  const buildSystemPrompt = (discipline) =>
    `You are Cilo, a warm and intellectually rigorous humanities AI companion. \
You specialise in philosophy, history, literature, art history, linguistics, \
religious studies, classical studies, cultural studies, ethics, and political theory.

Voice and style:
- Write in flowing, essayistic prose â€” never bullet points or numbered lists.
- Reference key thinkers, texts, and traditions naturally and accurately.
- Hold complexity with care: present multiple perspectives, honour ambiguity.
- Be genuinely curious; let enthusiasm for ideas show without being performative.
- Aim for 2â€“4 rich paragraphs â€” focused, not exhaustive.
- Use **bold** sparingly for key names or terms, *italics* for titles and emphasis.
- Occasionally use a > blockquote for a particularly resonant quotation.
- Close with something that opens further inquiry when it feels natural.

Current discipline focus: ${discipline}. Follow the inquiry wherever it leads.`;

  /* â”€â”€ Markdown-lite renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderMarkdown(raw) {
    const safe = raw
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    return safe
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,     '<em>$1</em>')
      .replace(/^&gt; (.+)$/gm,  '<blockquote>$1</blockquote>')
      .split(/\n{2,}/)
      .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
      .join('');
  }

  /* â”€â”€ App (IIFE module pattern) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const App = (() => {
    let conversationHistory = [];
    let currentDiscipline   = 'philosophy';
    let isLoading           = false;

    const feed       = document.getElementById('feed');
    const inputEl    = document.getElementById('composer-input');
    const sendBtnEl  = document.getElementById('send-btn');
    const pillEl     = document.getElementById('discipline-pill');

    /* â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    function removeWelcome() {
      document.getElementById('welcome')?.remove();
    }

    function scrollToBottom() {
      feed.scrollTop = feed.scrollHeight;
    }

    function setLoadingState(state) {
      isLoading = state;
      sendBtnEl.disabled = state;
    }

    function buildTypingIndicator() {
      const el = document.createElement('div');
      el.className = 'typing-dots';
      el.innerHTML = '<span></span><span></span><span></span>';
      return el;
    }

    function buildMessageNode(role, content) {
      const isUser  = role === 'user';
      const wrapper = document.createElement('div');
      wrapper.className = 'message';

      const row    = document.createElement('div');
      row.className = 'message-row';

      const avatar = document.createElement('div');
      avatar.className = `avatar avatar--${isUser ? 'user' : 'cilo'}`;
      avatar.textContent = isUser ? 'ğŸŒ¸' : 'âœ¦';
      avatar.setAttribute('aria-hidden', 'true');

      const body   = document.createElement('div');
      body.className = 'message-body';

      const sender = document.createElement('div');
      sender.className = 'message-sender';
      sender.textContent = isUser ? 'you' : 'cilo';

      const bubble = document.createElement('div');
      bubble.className = `bubble bubble--${isUser ? 'user' : 'cilo'}`;

      if (content instanceof Node) {
        bubble.appendChild(content);
      } else {
        bubble.innerHTML = content;
      }

      body.append(sender, bubble);
      row.append(avatar, body);
      wrapper.appendChild(row);

      return { wrapper, bubble };
    }

    function appendMessage(role, content) {
      removeWelcome();
      const { wrapper, bubble } = buildMessageNode(role, content);
      feed.appendChild(wrapper);
      scrollToBottom();
      return bubble;
    }

    /* â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    async function fetchReply() {
  const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      messages: conversationHistory,
      discipline: currentDiscipline
    })
  });

  if (!response.ok) {
    throw new Error("Server error");
  }

  const data = await response.json();
  return data.reply || "Cilo paused in thought.";
}
    }

    /* â”€â”€ Core send flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    async function send() {
      const text = inputEl.value.trim();
      if (!text || isLoading) return;

      setLoadingState(true);
      inputEl.value = '';
      autoResize();

      appendMessage('user', text);
      conversationHistory.push({ role: 'user', content: text });

      const ciloBubble = appendMessage('assistant', buildTypingIndicator());

      try {
        const reply = await fetchReply();
        conversationHistory.push({ role: 'assistant', content: reply });
        ciloBubble.innerHTML = renderMarkdown(reply);
      } catch {
        ciloBubble.innerHTML = '<p><em>something went quiet on my end â€” please try again.</em></p>';
      }

      scrollToBottom();
      setLoadingState(false);
      inputEl.focus();
    }

    /* â”€â”€ Textarea auto-resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    function autoResize() {
      inputEl.style.height = 'auto';
      inputEl.style.height = `${Math.min(inputEl.scrollHeight, 160)}px`;
    }

    /* â”€â”€ Public methods â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    function setDiscipline(navItem) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      navItem.classList.add('active');
      currentDiscipline = navItem.dataset.disc;
      pillEl.textContent = `${DISCIPLINE_ICONS[currentDiscipline] ?? 'âœ¦'} ${currentDiscipline}`;
    }

    function useStarter(card) {
      const labelEl = card.querySelector('.starter-label');
      const text = card.textContent.replace(labelEl.textContent, '').trim();
      inputEl.value = text;
      autoResize();
      inputEl.focus();
    }

    function reset() {
      conversationHistory = [];
      location.reload();
    }

    /* â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    inputEl.addEventListener('input', autoResize);

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    sendBtnEl.addEventListener('click', send);

    return { setDiscipline, useStarter, reset };
  })();
</script>

</body>
</html>
